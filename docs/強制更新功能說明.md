# 強制更新功能說明

## 概述

KanaKana應用已集成強制更新機制，確保用戶始終使用最新版本的應用，以獲得最佳體驗和安全性。

## 功能特點

### 1. 自動版本檢查
- 應用啟動時自動檢查版本更新
- 支持iOS和Android平台
- 可配置檢查間隔

### 2. 強制更新
- 當檢測到需要強制更新時，阻止用戶使用舊版本
- 顯示美觀的更新提示界面
- 直接跳轉到應用商店進行更新

### 3. 可選更新
- 支持可選更新提示
- 用戶可選擇稍後更新或立即更新

### 4. 錯誤處理
- 網絡錯誤時的優雅處理
- 重試機制
- 離線模式下的降級處理

## 技術實現

### 文件結構
```
src/
├── utils/
│   └── versionCheck.ts          # 版本檢查工具
├── hooks/
│   └── useVersionCheck.ts       # 版本檢查Hook
├── components/common/
│   └── ForceUpdateModal.tsx     # 強制更新模態框
└── hooks/
    └── useAppInitialization.ts  # 應用初始化Hook（已更新）
```

### 核心組件

#### 1. versionCheck.ts
- 版本信息獲取
- API調用邏輯
- 版本比較算法
- 錯誤處理

#### 2. useVersionCheck.ts
- 版本檢查狀態管理
- 重試機制
- 生命週期管理

#### 3. ForceUpdateModal.tsx
- 美觀的更新提示界面
- 應用商店跳轉
- 重試功能

## 配置說明

### 1. app.json 配置
```json
{
  "expo": {
    "extra": {
      "versionCheck": {
        "enabled": true,
        "apiUrl": "https://neobase.app/v1/workflows/run",
        "checkInterval": 3600000
      }
    }
  }
}
```

### 2. 版本號管理
- iOS: `buildNumber` 和 `CFBundleShortVersionString`
- Android: `versionCode` 和 `versionName`

## API 集成

### 真實版本號API
應用已集成真實的版本號API：

**API端點**: `https://neobase.app/v1/workflows/run`

**請求格式**:
```json
{
  "inputs": {},
  "response_mode": "blocking",
  "user": "kana"
}
```

**響應格式**:
```json
{
  "task_id": "ce977f80-e57f-4f63-8139-f7387c24d0ce",
  "workflow_run_id": "3c21e49e-3be3-4d7f-8bad-2657a2cdda16",
  "data": {
    "id": "3c21e49e-3be3-4d7f-8bad-2657a2cdda16",
    "workflow_id": "dc262c1a-5ae5-42cf-9fca-571dfe69f0b0",
    "status": "succeeded",
    "outputs": {
      "answer": "1.1.0"
    },
    "error": null,
    "elapsed_time": 0.0907452,
    "total_tokens": 0,
    "total_steps": 2,
    "created_at": 1754005806,
    "finished_at": 1754005806
  }
}
```

**認證**: 使用Bearer Token: `app-uoOi4HzYwlp5PWmrgb583ZWJ`

### 版本比較邏輯
- 從API響應中提取 `data.outputs.answer` 作為最新版本號
- 與當前應用版本進行語義化版本比較
- 如果當前版本低於最新版本，則提示更新

## 部署指南

### 1. 生產環境配置
- API端點已配置為生產環境地址
- 認證Token已集成到代碼中
- 版本比較邏輯已實現

### 2. 版本發布流程
1. 更新API中的版本號（通過Neobase工作流）
2. 構建並發布應用
3. 用戶啟動應用時自動檢查更新

### 3. 應用商店URL
更新以下文件中的應用商店URL：
- `src/utils/versionCheck.ts` - `getDefaultUpdateUrl` 函數

## 測試指南

### 1. API測試
```bash
cd scripts
node test-real-api.js
```

### 2. 應用內測試
1. 確保API返回較高的版本號（如1.1.0）
2. 應用當前版本為1.0.0
3. 啟動應用查看更新提示

### 3. 測試場景
- 正常版本檢查
- 強制更新場景
- 網絡錯誤處理
- 離線模式處理

## 注意事項

### 1. 版本號格式
- 使用語義化版本號 (Semantic Versioning)
- 格式：`major.minor.patch`
- 例如：`1.0.0`, `1.1.0`, `2.0.0`

### 2. 網絡安全
- 使用HTTPS進行API調用
- Bearer Token認證
- 防止版本檢查被繞過

### 3. 用戶體驗
- 避免頻繁的版本檢查
- 提供清晰的更新說明
- 支持離線使用（不強制更新時）

## 故障排除

### 常見問題

1. **版本檢查失敗**
   - 檢查網絡連接
   - 確認API端點可訪問
   - 檢查認證Token是否有效

2. **強制更新不生效**
   - 確認API返回的版本號正確
   - 檢查版本比較邏輯
   - 確認應用版本號正確

3. **應用商店跳轉失敗**
   - 檢查URL格式
   - 確認應用商店ID正確
   - 測試URL可訪問性

### 調試技巧
- 查看控制台日誌
- 使用React Native Debugger
- 檢查網絡請求
- 驗證API響應格式

## 未來改進

1. **增量更新**
   - 支持應用內更新
   - 減少下載大小

2. **智能更新**
   - 基於用戶行為的更新提示
   - 分階段發布

3. **分析集成**
   - 更新成功率統計
   - 用戶更新行為分析

4. **多語言支持**
   - 更新提示多語言化
   - 本地化更新說明 